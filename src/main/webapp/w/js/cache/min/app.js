var services=angular.module("common.services",[]),controllers=angular.module("xdApp.controllers",["common.directives"]),directives=angular.module("common.directives",["common.services"]);controllers.controller("taxController",["$scope","$rootScope","common","modal","menu","$state","$filter","$mdSidenav",function(a,b,c,d,e,f,g,h){this.isOpen=a.isOpen=function(a){return e.isSectionSelected(a)},this.toggleOpen=a.toggleOpen=function(a){e.toggleSelectSection(a)},a.menuOpen=!0,a.toggleMenu=function(){a.menuOpen=!a.menuOpen},a.menu=e,a.loginSuccess=!1,a.$on("loginSuccess",function(d,e,h,j){a.loginSuccess=!0,b.user=a.user=e,b.mods=j,c.loadAllPage("/dept/obtainDepts.cmd",function(a){b.depts=a.data}),b.back=function(){history.back()},b.allow=function(a){var c=!1;return b.mods.each(function(b){c||b.id!==a||(c=!0)}),c},b.constructSelectedId=function(a,b){var c=a.selection.getSelectedRows(),d={};return d[b]=[],angular.forEach(c,function(a){d[b].push(a.id)}),d},b.convertDate=function(a){return angular.isDate(a)?g("date")(a,"yyyy-MM-dd"):a},b.convertDates=function(a){angular.forEach(a,function(c){a[i]=b.convertDates(c)})},b.convertList=function(a,b,c){c=c||"id";var d=a[b];angular.forEach(d,function(d,e){a[b+"["+e+"]."+c]=d}),delete a[b]},b.onlyTheFirstDayPredicate=function(a){return 1===a.getDate()},b.convertParams=function(a,c){for(var d in a)a[d]=b.convertDate(a[d]);var e=a[c];angular.forEach(e,function(d,e){for(var f in d)"$$hashKey"!==f&&(a[c+"["+e+"]."+f]=b.convertDate(d[f]))}),delete a[c]},b.onlyYearAndMonth=function(a){return angular.isBlank(a)?"":g("date")(new Date(a),"yyyy-MM")},f.go(h)}),a.logout=function(){c.post("/user/userLogout.cmd",null,{}),a.loginSuccess=!1,f.go("login")},a.changePassword=function(b){d.open({title:"修改密码",url:"js/tpl/change-password.html",canGo:function(a){return console.log(a),a.password&&a.newPassword&&a.newPassword===a.newPassword2},ok:function(b){b.name=a.user.name,c.post("/user/changePassword.cmd",b,{fail:function(){d.alert("修改密码失败")}})}},a)}}]),controllers.controller("BudgetItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.budget=f.budget,a.indexes=["一、","二、","三、","四、","五、","六、","七、","八、","九、","十、"]}]),controllers.controller("BudgetCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.showDetail=function(a){h.go("budget-item",{budget:a.entity})},a.loadBudgets=function(b,c){d.loadPage("/budget/obtainBudgets.cmd",angular.extend({page:b,limit:c},a.query),{success:function(b){a.budgetGrid.data=b.data,a.budgetGrid.totalItems=b.total}})},a.budgetGrid=f.createBudgetGrid(a,a.loadBudgets,c),a.loadBudgets(1,a.budgetGrid.paginationPageSize),a.delBudget=function(){var b=a.budgetGrid.selection.getSelectedRows(),c={budgetIds:[]};angular.forEach(b,function(a){c.budgetIds.push(a.projectId)}),d.post("/budget/deleteBudget.cmd",c,{success:function(){a.budgetGrid.refresh()}})}}]),controllers.controller("CalculateItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration","util",function(a,b,c,d,e,f,g,h){a.budget=f.budget;var i=[{name:"17%",value:.17},{name:"13%",value:.13},{name:"11%",value:.11},{name:"6%",value:.06},{name:"5%",value:.05},{name:"3%",value:.03},{name:"1.5%",value:.015},{name:"0%",value:0}],j=[{name:"序号",enableCellEdit:!1,field:"itemIndex"},{name:"材料名称",enableCellEdit:!1,field:"materialName"},{name:"型号规格",enableCellEdit:!1,field:"model"},{name:"单位",enableCellEdit:!1,field:"unit"},{name:"数量",enableCellEdit:!1,field:"count"},{name:"预算价",enableCellEdit:!1,field:"price"},{name:"合计",enableCellEdit:!1,field:"total"},{name:"税率",editModelField:"taxRatio",cellTemplate:'<div class="ui-grid-cell-contents">{{row.entity.taxRatio !== null? (row.entity.taxRatio* 100 + "%") : ""}}</div>',editableCellTemplate:"ui-grid/dropdownEditor",enableCellEdit:!0,editDropdownIdLabel:"value",editDropdownValueLabel:"name",editDropdownOptionsArray:i},{name:"税额",enableCellEdit:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{row.entity.taxRatio !== null ? (row.entity.total * row.entity.taxRatio/ (row.entity.taxRatio + 1)).toFixed(2) : ""}}</div>'},{name:"不含税金额",enableCellEdit:!1,cellTemplate:'<div class="ui-grid-cell-contents">{{row.entity.taxRatio !== null ? (row.entity.total / (row.entity.taxRatio + 1)).toFixed(2) : ""}}</div>'}];a.createGrid=function(c){return{columnDefs:angular.copy(j),data:c,onRegisterApi:function(c){c.edit.on.afterCellEdit(a,function(c,d,e,f){a.$apply(),a.updateTotal(),b.post("/calculate/updateRatio.cmd",{id:c.id,taxRatio:c.taxRatio})})}}},a.manBudgetGrid=a.createGrid([]),a.materialBudgetGrid=a.createGrid([]),a.machineBudgetGrid=a.createGrid([]),angular.forEach(a.budget.groups,function(b){"人工"===b.name?a.manBudgetGrid=a.createGrid(b.items):"材料"===b.name?a.materialBudgetGrid=a.createGrid(b.items):"机械"===b.name&&(a.machineBudgetGrid=a.createGrid(b.items))}),a.totalBudgetGrid={columnDefs:[{name:"人工",field:"man",cellFilter:"toFixed"},{name:"材料",field:"material",cellFilter:"toFixed"},{name:"机械",field:"machine",cellFilter:"toFixed"},{name:"合计",field:"total",cellFilter:"toFixed"}],data:[]},a.updateTotal=function(){var b=0,c=0,d=0;angular.forEach(a.manBudgetGrid.data,function(a){b+=h.taxCount(a)}),angular.forEach(a.materialBudgetGrid.data,function(a){c+=h.taxCount(a)}),angular.forEach(a.machineBudgetGrid.data,function(a){d+=h.taxCount(a)}),a.totalBudgetGrid.data=[{man:b,material:c,machine:d,total:b+c+d}]},a.updateTotal(),a.exportCalculate=function(){var b="../calculate/exportCalculate.cmd?";b+="id="+a.budget.projectId,window.open(b,"_self")}}]),controllers.controller("CalculateCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$stateParams","$state","util",function(a,b,c,d,e,f,g,h,i,j){h.budgets&&(angular.forEach(h.budgets,function(a){var b=c.i18n(2,"rate",a.project.rate);b=parseInt(b.substring(0,b.length-1)),b/=100,a.unTaxCount=a.project.totalCount/(1+b),a.saleCount=a.unTaxCount*b,a.inCount=0,angular.forEach(a.groups,function(b){"人工"!==b.name&&"材料"!==b.name&&"机械"!==b.name||angular.forEach(b.items,function(b){a.inCount+=j.taxCount(b)})}),a.shouldTaxCount=a.saleCount-a.inCount,a.taxPercent=a.shouldTaxCount/a.unTaxCount}),a.taxCalculateGrid={configuration:c,columnDefs:[{name:"项目名称",field:"project.name"},{name:"合同金额",field:"project.totalCount"},{name:"税率",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(2,"rate",row.entity.project.rate)}}</div>'},{name:"不含税金额",field:"unTaxCount",cellFilter:"toFixed"},{name:"销项税额 ",field:"saleCount",cellFilter:"toFixed"},{name:"进项税额",field:"inCount",cellFilter:"toFixed"},{name:"应纳税额",field:"shouldTaxCount",cellFilter:"toFixed"},{name:"税负",field:"taxPercent",cellFilter:"toFixed:4"}],data:h.budgets}),a.exportTaxCalculate=function(){var a="../calculate/exportTaxCalculate.cmd?";angular.forEach(h.budgets,function(b){a+="budgetIds="+b.projectId+"&"}),window.open(a,"_self")},a.calculateBudget=function(){var b=a.budgetGrid.selection.getSelectedRows()[0];i.go("calculate-item",{budget:b})},a.showTaxCalculateBudget=function(){var b=a.budgetGrid.selection.getSelectedRows();i.go("tax-calculate-item",{budgets:b})},a.disableShowTaxCalculte=function(){var b=a.budgetGrid.selection.getSelectedRows();return b.length<1||angular.each(b,function(a){return angular.each(a.groups,function(a){if("人工"===a.name||"材料"===a.name||"机械"===a.name)return angular.each(a.items,function(a){if(null===a.taxRatio)return!0})})})}}]),controllers.controller("ConfCtrl",["$scope","common","modal","module","$filter","menu",function(a,b,c,d,e,f){a.loadConfs=function(c,d){b.loadPage("/conf/obtainConfigs.cmd",{page:c,limit:d},{success:function(b){a.confGrid.data=b.data,a.confGrid.totalItems=b.total}})},a.confGrid=d.createConfGrid(a,a.loadConfs),a.loadConfs(1,a.confGrid.paginationPageSize),a.openConfInfo=function(d){c.open(angular.extend({url:"js/tpl/conf-info.html",canGo:function(a){return a.groupNo>-1&&a.confValue&&a.confName},ok:function(c){b.post("/conf/saveConfig.cmd",c,{success:function(){a.confGrid.refresh()}})}},d),a)},a.addConf=function(){a.openConfInfo({title:"新增配置"},a)},a.modConf=function(){var b=a.confGrid.selection.getSelectedRows()[0];a.openConfInfo({title:"修改配置",data:b},a)},a.delConf=function(){var c=a.confGrid.selection.getSelectedRows(),d={confIds:[]};angular.forEach(c,function(a){d.confIds.push(a.id)}),b.post("/conf/deleteConfig.cmd",d,{success:function(){a.confGrid.refresh()}})}}]),controllers.controller("ConstructionProgressCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.openProgressInfo=function(b){var c={url:"js/tpl/construction-progress-info.html",width:400,ok:function(a){d.post("/construction-progress/saveProgress.cmd",a,{success:function(){e.alert("工程进度录入成功。")},fail:function(a){1===a.errorCode&&e.alert("工程进度录入失败：己存在对应月份的记录。")}})}};e.open(angular.extend(c,b),a)},a.addProgress=function(){var b=a.getSelectedProjects()[0];a.openProgressInfo({title:"新增工程进度",add:!0,data:{"project.id":b.id,importUser:a.user.name},projectName:b.name})}}]),controllers.controller("ContractProgressCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.openProgressInfo=function(b){var c={url:"js/tpl/contract-progress-info.html",width:400,ok:function(a){d.post("/contract-progress/saveProgress.cmd",a,{success:function(){e.alert("合同进度录入成功。")},fail:function(a){1===a.errorCode&&e.alert("合同进度录入失败：己存在对应月份的记录。")}})}};e.open(angular.extend(c,b),a)},a.addProgress=function(){var b=a.getSelectedProjects()[0];a.openProgressInfo({title:"新增合同进度",add:!0,data:{"project.id":b.id,importUser:a.user.name},projectName:b.name})}}]),controllers.controller("CostTaxCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration","supplierTypeName","util",function(a,b,c,d,e,f,g,h,i){h.success(function(b){a.modal=d.getSupplierTypes({allSupplierTypes:b}),a.$watch("identityType",function(b){a.modal.supplierTypes=a.modal.allSupplierTypes[b]})}),a.identityType=1,a.costTaxGrid={columnDefs:[{name:"供应商类别",field:"supplierType"},{name:"最优采购成本",field:"cost",cellFilter:"toFixed"},{name:"税率",field:"rate"},{name:"进项税",field:"inCount",cellFilter:"toFixed"},{name:"最优采购支付总额",field:"finallyTotal"},{name:"备注",field:"remark"}]},a.calculate=function(){function b(b){var c=a.modal.allSupplierTypes[b][d].supplierSubTypeNames[e];return i.rate(c.name)}function c(b,c){var d=parseFloat(a.totalCount);c/=100,this.supplierType=b+"类",this.cost=d/(1+c),this.rate=c,this.inCount=this.cost*c,this.finallyTotal=d}var d,e;a.modal.supplierTypes.each(function(b,c){if(b===a.supplierType)return d=c,!0}),a.supplierType.supplierSubTypeNames.each(function(b,c){if(b===a.supplierSubType)return e=c,!0});var f=[];angular.forEach(b(1),function(a){f.push(new c("A",a))}),angular.forEach(b(2),function(a){f.push(new c("B",a))});var g=new c("C",0);g.remark="假定取得增值税发票",g.cost=g.cost/1.03,f.push(g),g=new c("C",0),g.remark="假定无法取得发票去税务机关代开",f.push(g),a.costTaxGrid.data=f}}]),controllers.controller("DeptCtrl",["$scope","common","modal","module","$filter",function(a,b,c,d,e){a.loadDepts=function(c,d){b.loadPage("/dept/obtainDepts.cmd",{page:c,limit:d},{success:function(b){a.deptGrid.data=b.data,angular.forEach(a.deptGrid.data,function(a){a.roleNames="",angular.forEach(a.roles,function(b){a.roleNames+=b.name+" "})}),a.deptGrid.totalItems=b.total}})},a.deptGrid=d.createDeptGrid(a,a.loadDepts),a.loadDepts(1,a.deptGrid.paginationPageSize)}]),controllers.controller("EngineeringPurchaseItemCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","supplierTypeName","util",function(a,b,c,d,e,f,g,h,i,j,k){a.modal=f.getSupplierTypes(i.project),angular.isBlank(a.modal.data)?a.modal.data={}:a.modal.data.dept=a.modal.data.dept.id,j.success(function(b){a.modal.allSupplierTypes=b,a.$watch("modal.data.supplierType",function(b){a.modal.supplierTypes=a.modal.allSupplierTypes[b]}),a.$watch("modal.data.serviceType",function(b){a.modal.supplierTypes&&angular.each(a.modal.supplierTypes,function(c){if(c.id===b)return a.modal.supplierSubTypes=c.supplierSubTypeNames,!0})}),a.$watch("modal.data.serviceSubType",function(b){angular.each(a.modal.supplierSubTypes,function(c){if(c.id===b)return a.modal.data.rate=k.rate(c.name)[0]/100,!0})})}),a.$watch("modal.data.productCount + modal.data.price + modal.data.rate",function(){var b=a.modal.data,c=parseFloat(b.productCount)||0,d=parseFloat(b.price)||0,e=parseFloat(b.rate)||0;b.unTaxCount=c*d,b.rateCount=b.unTaxCount*e,b.total=b.unTaxCount+b.rateCount}),a.querySupplier=function(a){return d.loadAllPage2("/supplier/obtainSuppliers.cmd",{name:a})},a.queryPorject=function(a){return d.loadAllPage2("/project/obtainProjects.cmd",{name:a})},a.savePurchase=function(){function b(a){c[a+".id"]=c[a].id||c[a],delete c[a]}var c=angular.copy(a.modal.data);b("dept"),b("project"),b("supplier"),d.post("/"+a.modal.type+"-purchase/savePurchases.cmd",c,function(){e.alert("保存采购成功")})}}]),controllers.controller("EngineeringPurchaseCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","supplierTypeName",function(a,b,c,d,e,f,g,h,i){a.query={dept:void 0},a.loadEngineerPurchases=function(b,c){d.loadPage("/"+a.type+"-purchase/obtainPurchases.cmd",{page:b,limit:c,"dept.id":a.query.dept==-1?void 0:a.query.dept},{success:function(b){a.purchaseGrid.data=b.data,a.purchaseGrid.totalItems=b.total}})},a.purchaseGrid=f.createEngineeringPurchaseGrid(a,a.loadEngineerPurchases,c),a.deletePurchases=function(){d.post("/"+a.type+"-purchase/deletePurchases.cmd",a.constructSelectedId(a.purchaseGrid,"purchaseIds"),{success:function(){a.purchaseGrid.refresh()}})},a.modPurchase=function(){h.go("engineering-purchase-item",{project:{type:a.type,add:!0,data:a.purchaseGrid.selection.getSelectedRows()[0]}})},a.$watch("query.dept",function(b){a.loadEngineerPurchases(1,a.purchaseGrid.paginationPageSize)}),a.addPurchase=function(b){a.showDetail(!0)},a.showDetail=function(b){h.go("engineering-purchase-item",{project:{type:a.type,add:b}})}}]),controllers.controller("LoginCtrl",["$scope","$mdSidenav","common","menu",function(a,b,c,d){a.login=function(){c.post("/user/userLogin.cmd",a.user,{success:function(b){var c=[],e=b.data;if(e){e.roles.each(function(a){a.mods.each(function(a){c.containsId(a)||c.push(a)})});var f=angular.copy(c);c=d.parseMenu(c,!0);var g;c.each(function(a){angular.isBlank(g)&&(g="link"===a.type?a.state:a.pages[0].state)}),a.$emit("loginSuccess",e,g,f)}}})}}]),controllers.controller("ProductImportCtrl",["$scope","common","modal","module","$filter",function(a,b,c,d,e){a.loadProductImports=function(c,d){b.loadPage("/product/obtainProductImports.cmd",{page:c,limit:d},{success:function(b){a.productImportGrid.data=b.data,a.productImportGrid.totalItems=b.total}})},a.productImportGrid=d.createProductImportGrid(a,a.loadProductImports),a.loadProductImports(1,a.productImportGrid.paginationPageSize),a.uploadFile=function(){b.uploadFile("/product/importProduct.cmd",{file:a.importFile[0].lfFile,userName:a.user.name},{success:function(b){a.productImportGrid.refresh(),c.alert("成功导入:"+b.data.right+"条，失败:"+b.data.wrong+"条")}})},a.delImport=function(){c.confirm("删除导入记录，将同时删除关联的商品信息，是否继续？",{postive:function(){b.post("/product-import/deleteProductImport.cmd",a.constructSelectedId(a.productImportGrid,"productImportIds"),{success:function(){a.productImportGrid.refresh()}})}})},a.approveImport=function(){c.confirm("导入记录审核通过后，所有关联的商品都将审核通过，是否继续？",{postive:function(){b.post("/product-import/approveProductImport.cmd",a.constructSelectedId(a.productImportGrid,"productImportIds"),{success:function(){a.productImportGrid.refresh()}})}})},a.canApprove=function(){if(!a.productImportGrid.selection)return!1;var b=a.productImportGrid.selection.getSelectedRows();return b.length>0&&!b.contains(function(a){return 0!==a.status})}}]),controllers.controller("ProductItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.modal=d.getProductTypes({add:!1,data:f.product}),a.approvalProduct=function(){b.post("/product/approvalProduct.cmd",{productIds:[a.modal.data.id]},{success:function(){a.modal.data.status=1}})}}]),controllers.controller("ProductCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.showDetail=function(a){h.go("product-item",{product:a.entity})},a.query={},a.loadProducts=function(b,c){d.loadPage("/product/obtainProducts.cmd",angular.extend({page:b,limit:c},a.query),{success:function(b){a.productGrid.data=b.data,a.productGrid.totalItems=b.total}})},a.productGrid=f.createProductGrid(a,a.loadProducts,c),a.loadProducts(1,a.productGrid.paginationPageSize),a.openProductInfo=function(b){var c=f.getProductTypes({url:"js/tpl/product-info.html",width:500,add:!0,ok:function(b){d.post("/product/saveProduct.cmd",b,{success:function(){a.productGrid.refresh()}})}});e.open(angular.extend(c,b),a)},a.addProduct=function(){a.openProductInfo({title:"新增商品"},a)},a.delProduct=function(){d.post("/product/deleteProduct.cmd",a.constructSelectedId(a.productGrid,"productIds"),{success:function(){a.productGrid.refresh()}})},a.canApprove=function(){var b=a.productGrid.selection.getSelectedRows();return b.length>0&&!b.contains(function(a){return 0!==a.status})},a.approvalProduct=function(){d.post("/product/approvalProduct.cmd",a.constructSelectedId(a.productGrid,"productIds"),{success:function(){a.productGrid.refresh()}})},a.loadImports=function(){d.loadAllPage("/product/obtainProductImports.cmd",{success:function(b){a.imports=b.data}})},a.queryProduct=function(){a.productGrid.refresh(!0)},a.exportProduct=function(){var b="../product/exportProduct.cmd?";for(var c in a.query)b+=c+"="+a.query[c],b+="&";window.open(b,"_self")}}]),controllers.controller("ProgressItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.project=f.project,a.query={"project.id":f.project.id},a.isContract="contract"===a.project.itemType,a.isContract?(a.tpl="js/tpl/contract-progress-info.html",a.saveCmd="/contract-progress/saveProgress.cmd",a.moduleName="createContractGrid",a.loadProgressUrl="/contract-progress/obtainProgresses.cmd"):(a.tpl="js/tpl/construction-progress-info.html",a.saveCmd="/construction-progress/saveProgress.cmd",a.moduleName="createConstructionItemGrid",a.loadProgressUrl="/construction-progress/obtainProgresses.cmd"),a.loadProgress=function(c,d){b.loadPage(a.loadProgressUrl,angular.extend({page:c,limit:d},a.query),{success:function(b){for(var c=0,d=b.data,e=d.length-1;e>-1;e--)d[e].lastAllCount=c,c+=d[e].finished;a.itemGrid.data=b.data,a.itemGrid.totalItems=b.total}})},a.itemGrid=d[a.moduleName](a,a.loadProgress,g),a.loadProgress(1,9999),a.modProgress=function(){var d={url:a.tpl,width:400,projectName:a.project.name,data:a.itemGrid.selection.getSelectedRows()[0],ok:function(d){var e=angular.copy(d);delete e.project,e["project.id"]=d.project.id,b.post(a.saveCmd,e,{success:function(){c.alert("进度修改成功。"),a.itemGrid.refresh()}})}};c.open(d,a)}}]),controllers.controller("ProjectItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.modal=d.getProjectTypes({add:!1,data:f.project})}]),controllers.controller("ProjectPurchaseCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.importProjectPurchase=function(){d.uploadFile("/purchase/importProjectPurchase.cmd",{file:a.importFile[0].lfFile,importDate:a.importDate,operator:a.user.name,projectId:a.getSelectedProjects()[0].id},{success:function(a){e.alert("成功导入:"+a.data.right+"条")}})},a.showPurchase=function(b){h.go("purchase-import",{project:a.getSelectedProjects()[0]})}}]),controllers.controller("ProjectCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state",function(a,b,c,d,e,f,g,h){a.modal=f.getProjectTypes(),a.showDetail=function(a){h.go("project-item",{project:a.entity})},a.query={},a.loadProjects=function(b,c){d.loadPage("/project/obtainProjects.cmd",angular.extend({page:b,limit:c},a.query),{success:function(b){a.projectGrid.data=b.data,a.projectGrid.totalItems=b.total}})},a.projectGrid=f.createProjectGrid(a,a.loadProjects,c),a.loadProjects(1,a.projectGrid.paginationPageSize),a.openProjectInfo=function(b){var c=f.getProjectTypes({url:"js/tpl/project-info.html",width:750,add:!0,addOutSource:function(){this.data.outSources||(this.data.outSources=[]),this.data.outSources[this.data.outSources.length]={}},ok:function(b){a.convertParams(b,"outSources"),d.post("/project/saveProject.cmd",b,{success:function(){a.projectGrid.refresh()}})}});e.open(angular.extend(c,b),a)},a.addProject=function(){a.openProjectInfo({title:"新增项目"},a)},a.delProject=function(){d.post("/project/deleteProject.cmd",a.constructSelectedId(a.projectGrid,"projectIds"),{success:function(){a.projectGrid.refresh()}})},a.queryProject=function(){a.projectGrid.refresh(!0)},a.exportProject=function(){var b="../project/exportProject.cmd?projectId=";b+=a.projectGrid.selection.getSelectedRows()[0].id,window.open(b,"_self")},a.modProject=function(){var b=a.projectGrid.selection.getSelectedRows()[0];a.openProjectInfo({title:"修改项目",data:angular.copy(b)},a)},a.uploadFile=function(){d.uploadFile("/budget/importBudget.cmd",{file:a.importFile[0].lfFile,userName:a.user.name,projectId:a.projectGrid.selection.getSelectedRows()[0].id},{success:function(b){a.budgetGrid.refresh(),e.alert("成功导入:"+b.data.right+"条")}})},a.getSelectedProjects=function(){return a.projectGrid.selection.getSelectedRows()},a.showProgress=function(b){var c=angular.copy(a.getSelectedProjects()[0]);c.itemType=b,h.go("progress-item",{project:c})},a.showProgressAndReceipt=function(){h.go("receipt-progress-item",{project:{project:a.getSelectedProjects()[0],belong:a.belong}})}}]),controllers.controller("PurchaseImportCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.project=f.project,a.loadPurchaseImports=function(c,d){var e=angular.extend({page:c,limit:d,projectId:a.project.id},a.query);e.startDate=e.startDate||"1971-1-1",e.endDate=e.endDate||"2064-1-1",b.loadPage("/purchase/obtainPurchaseImports.cmd",e,{success:function(b){a.purchaseImportGrid.data=b.data,a.purchaseImportGrid.totalItems=b.total}})},a.purchaseImportGrid=d.createPurchaseImportGrid(a,a.loadPurchaseImports,g),a.loadPurchaseImports(1,a.purchaseImportGrid.paginationPageSize),a.deletePurchaseImport=function(){c.confirm("删除导入记录，将同时删除关联的采购记录，是否继续？",{postive:function(){b.post("/purchase/deletePurchaseImport.cmd",a.constructSelectedId(a.purchaseImportGrid,"purchaseImportIds"),{success:function(){a.purchaseImportGrid.refresh()}})}})},a.loadPurchases=function(c,d){var e=angular.extend({page:c,limit:d,projectId:a.project.id},a.query2);e.startDate=e.startDate||"1971-1-1",e.endDate=e.endDate||"2064-1-1",b.loadPage("/purchase/obtainPurchases.cmd",e,{success:function(b){a.purchaseGrid.data=b.data,a.purchaseGrid.totalItems=b.total}})},a.purchaseGrid=d.createPurchaseGrid(a,a.loadPurchases,g),a.loadPurchases(1,a.purchaseGrid.paginationPageSize)}]),controllers.controller("PurchaseQueryCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","supplierTypeName",function(a,b,c,d,e,f,g,h,i){a.queryPorject=function(a){return d.loadAllPage2("/project/obtainProjects.cmd",{name:a})},a.loadPurchases=function(b,c){var e=angular.extend({page:b,limit:c,projectId:a.selectedProject.id},a.query2);e.startDate=e.startDate||"1971-1-1",e.endDate=e.endDate||"2064-1-1";var f;switch(a.queryType){case"1":f="/purchase/obtainPurchases.cmd";break;case"2":f="/engineering-purchase/obtainPurchasesForQuery.cmd";break;case"3":f="/composite-purchase/obtainPurchasesForQuery.cmd"}d.loadPage(f,e,function(b){a.purchaseQueryGrid.data=b.data,a.purchaseQueryGrid.totalItems=b.total})},a.purchaseQueryGrid=f.createPurchaseGrid(a,a.loadPurchases,c)}]),controllers.controller("ReceiptProgressItemCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","supplierTypeName",function(a,b,c,d,e,f,g,h,i,j){a.project=i.project.project,a.config=c,a.loadPage=function(){d.loadPage("/project-receipt/receiptAndProgress.cmd",{projectId:a.project.id,belong:i.project.belong},function(b){a.show=b})},a.loadPage(),a.modProgress=function(){e.open({url:"js/tpl/receipt-progress-remark-info.html",width:500,title:"编辑工程月进度、收款说明",projectName:a.project.name,data:{projectId:a.project.id,belong:i.project.belong,id:a.show.addition_id,progress:a.show.addition_progress,progress2:a.show.addition_progress2},ok:function(b){d.post("project-receipt/saveProgressRemark.cmd",b,a.loadPage)}})},a.exportProgress=function(){var b="../project-receipt/exportProgress.cmd?projectId=";b+=a.project.id+"&belong="+i.project.belong,window.open(b,"_self")},a.print=function(){window.print()}}]),controllers.controller("ReceiptCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","supplierTypeName",function(a,b,c,d,e,f,g,h,i,j){a.showReceiptInfo=function(b){var c={url:"js/tpl/receipt-info.html",width:400,ok:function(b){b["project.id"]=b.project.id,delete b.project,d.post("/project-receipt/saveReceipt.cmd",b,{success:function(){e.alert("项目收款录入成功。"),a.itemGrid&&a.itemGrid.refresh()},fail:function(a){1===a.errorCode&&e.alert("项目收款录入失败：己存在对应月份的记录。")}})}};e.open(angular.extend(c,b),a)},a.addReceipt=function(){var b=a.getSelectedProjects()[0];a.showReceiptInfo({title:"新增项目收款",add:!0,data:{project:b}})},a.showReceipt=function(){var b=angular.copy(a.getSelectedProjects()[0]);h.go("receipt-item",{project:b})},i.project&&(a.project=i.project,a.loadReceipt=function(b,c){d.loadAllPage("/project-receipt/obtainReceipts.cmd",function(b){a.itemGrid.data=[];var c=0;angular.forEach(b.data,function(b){var d=angular.extend({allByLastMonth:c,allByNow:c+b.count,percent:100*(c+b.count)/b.project.totalCount},b);c+=b.count,a.itemGrid.data.push(d)})},{"project.id":a.project.id})},a.itemGrid=f.createReceiptGrid(a,a.loadReceipt,c),a.loadReceipt(),a.deleteReceipt=function(){d.post("/project-receipt/deleteReceipt.cmd",a.constructSelectedId(a.itemGrid,"receiptIds"),{success:function(){a.itemGrid.refresh()}})},a.modReceipt=function(){a.showReceiptInfo({title:"修改收款",data:a.itemGrid.selection.getSelectedRows()[0]})})}]),controllers.controller("RoleCtrl",["$scope","common","modal","module","$filter","menu",function(a,b,c,d,e,f){a.loadRoles=function(c,d){b.loadPage("/role/obtainRoles.cmd",{page:c,limit:d},{success:function(b){a.roleGrid.data=b.data,a.roleGrid.totalItems=b.total}})},a.roleGrid=d.createRoleGrid(a,a.loadRoles),a.loadRoles(1,a.roleGrid.paginationPageSize),a.openRoleInfo=function(d){var e=d.data;b.loadAllPage("/dept/obtainDepts.cmd",{success:function(g){var h=g.data,i=[];angular.forEach(h,function(a){angular.forEach(a.roles,function(b){e&&e.id===b.id&&(e.dept=a),angular.forEach(b.mods,function(a){i.contains(function(b){return b.id===a.id})||(i.push(a),a.selected=e&&e.mods.containsId(a))})})}),i=f.parseMenu(i,!1,"children");var j;c.open(angular.extend({url:"js/tpl/role-info.html",width:500,depts:h,mods:i,treeCallback:function(a,b){return j=b,!0},ok:function(c){c.deptId=c.dept.id,delete c.dept,delete c.mods,angular.forEach(j,function(a,b){c["mods["+b+"].id"]=a.id}),b.post("/role/saveRole.cmd",c,{success:function(){a.roleGrid.refresh()}})}},d),a)}})},a.addRole=function(){a.openRoleInfo({title:"新增角色"},a)},a.delRole=function(){var c=a.roleGrid.selection.getSelectedRows(),d={roleIds:[]};angular.forEach(c,function(a){d.roleIds.push(a.id)}),b.post("/role/deleteRole.cmd",d,{success:function(){a.roleGrid.refresh()}})},a.modRole=function(){var b=a.roleGrid.selection.getSelectedRows()[0];b=angular.copy(b),a.openRoleInfo({title:"修改角色",data:b},a)}}]),controllers.controller("SupplierItemCtrl",["$scope","common","modal","module","$filter","$stateParams","configuration",function(a,b,c,d,e,f,g){a.modal=d.getSupplierTypes(angular.extend({},f.supplier)),a.$watch("modal.data.identityType",function(b){a.modal.supplierTypes=a.modal.allSupplierTypes[b],a.modal.supplierSubTypes=[]}),a.$watch("modal.data.supplierTypes",function(b){a.modal.supplierSubTypes=[],angular.forEach(a.modal.supplierTypes,function(c){b&&b.contains(c.id)&&a.modal.supplierSubTypes.pushAll(c.supplierSubTypeNames)})}),a.modal.licenseImg=a.modal.data.licenseImg,a.modal.registryImg=a.modal.data.registryImg,a.modal.organizationImg=a.modal.data.organizationImg,a.modal.openAccountImg=a.modal.data.openAccountImg,a.saveSupplier=function(){function d(b){return angular.isBlank(e[b])?void(e[b]=a.modal[b]):(e[b+"F"]=a.modal.data[b][0].lfFile,void(e[b]=a.modal.data[b][0].lfFileName))}var e=angular.copy(a.modal.data);e.supplierTypes.each(function(b,c){e["supplierTypes["+c+"].supplierType"]=b;var d=angular.each(a.modal.supplierTypes,function(a){if(a.id===b)return a}),f=0;d.supplierSubTypeNames.each(function(a){e.supplierSubTypes.contains(a.id)&&(e["supplierTypes["+c+"].supplierSubTypes["+f++ +"].supplierSubType"]=a.id)})}),delete e.supplierTypes,delete e.supplierSubTypes,d("licenseImg"),d("openAccountImg"),d("organizationImg"),d("registryImg"),console.log(e),b.uploadFile("/supplier/saveSupplier.cmd",e,{success:function(){c.alert("供应商保存成功")}})},a.showImage=function(b){c.open({url:"js/tpl/supplier-img.html",width:800,title:"查看",imageName:"../supplier/showImage.cmd?supplierId="+a.modal.data.id+"&type="+b})}}]),controllers.controller("SupplierCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","supplierTypeName","$stateParams",function(a,b,c,d,e,f,g,h,i,j){a.query={dept:void 0},a.loadSuppliers=function(b,c){d.loadPage("/supplier/obtainSuppliers.cmd",{page:b,limit:c,dept:a.query.dept==-1?void 0:a.query.dept},{success:function(b){a.supplierGrid.data=b.data,a.supplierGrid.totalItems=b.total}})},a.$watch("query.dept",function(b){a.loadSuppliers(1,a.supplierGrid.paginationPageSize)}),a.supplierGrid=f.createSupplierGrid(a,a.loadSuppliers,c),j.man&&(a.supplierGrid=f.createSupplierGrid2(a,a.loadSuppliers,c)),a.loadSuppliers(1,a.supplierGrid.paginationPageSize),a.addSupplier=function(){a.showDetail({},!0)},a.modSupplier=function(){a.showDetail(a.supplierGrid.selection.getSelectedRows()[0],!0,!0)},a.showDetail=function(a,b,c){i.success(function(d){var e=d,f=a.supplierTypes;a.supplierTypes=[],a.supplierSubTypes=[],angular.forEach(f,function(b){a.supplierTypes.push(b.supplierType),b.supplierSubTypes.each(function(b){a.supplierSubTypes.push(b.supplierSubType)})}),h.go("supplier-item",{supplier:{data:a,add:b,edit:c,allSupplierTypes:e}})})},a.uploadFile=function(){d.uploadFile("/budget/importBudget.cmd",{file:a.importFile[0].lfFile,userName:a.user.name,supplierId:a.supplierGrid.selection.getSelectedRows()[0].id},{success:function(b){a.budgetGrid.refresh(),e.alert("成功导入:"+b.data.right+"条")}})}}]),controllers.controller("TaxAnalysisTaxCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","supplierTypeName",function(a,b,c,d,e,f,g,h,i,j){a.project=i.project.project,a.belong=i.project.belong,d.post("/tax-manager/taxAnalysis.cmd",{projectId:a.project.id,belong:a.belong},function(b){a.data={},angular.forEach(b,function(b,c){a.percent=c,a.data=b})}),a.export=function(){var b="../tax-manager/exportTax.cmd?projectId=";b+=a.project.id,b+="&belong="+a.belong,window.open(b,"_self")}}]),controllers.controller("TaxAnalysisCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","supplierTypeName",function(a,b,c,d,e,f,g,h,i,j){a.inCountAnalysis=function(){h.go("tax-analysis-in-count-item",{project:{project:a.getSelectedProjects()[0],belong:a.belong}})},a.taxAnalysis=function(){h.go("tax-analysis-tax-item",{project:{project:a.getSelectedProjects()[0],belong:a.belong}})},i.project&&(a.project=i.project.project,a.belong=i.project.belong,
d.post("/tax-manager/inCountAnalysis.cmd",{projectId:a.project.id,belong:a.belong},function(b){a.data={},angular.forEach(b,function(b,c){return"total"===c?void(a.total=b):void(a.data[c]=b)})}),a.export=function(){var b="../tax-manager/exportInCount.cmd?projectId=";b+=a.project.id,b+="&belong="+a.belong,window.open(b,"_self")})}]),controllers.controller("TaxQueryCompareCtrl",["$scope","$rootScope","configuration","common","modal","module","$filter","$state","$stateParams","util",function(a,b,c,d,e,f,g,h,i,j){a.descs=[1,-1],a.query=function(){e.wait(),d.post("/tax-manager/taxQueryCompare.cmd",{belong:a.belong},function(b){a.data=b,a.sortData(),e.hide()})},a.$watch("desc",function(b,c){a.sortData()}),a.sortData=function(){angular.isBlank(a.data)||a.data.sort(function(b,c){return(b[b.length-1]-c[c.length-1])*a.desc})},a.export=function(){j.downloadFile("../tax-manager/exportTaxQuery.cmd",{belong:a.belong})}}]),controllers.controller("UserCtrl",["$scope","common","modal","module","$filter",function(a,b,c,d,e){a.loadUsers=function(c,d){b.loadPage("/user/obtainUsers.cmd",{page:c,limit:d},{success:function(b){a.userGrid.data=b.data,a.userGrid.totalItems=b.total}})},a.userGrid=d.createUserGrid(a,a.loadUsers),a.loadUsers(1,a.userGrid.paginationPageSize),a.openUserInfo=function(d){b.loadAllPage("/dept/obtainDepts.cmd",{success:function(e){var f=e.data;if(d.data&&d.data.dept){var g=-1;f.each(function(a,b){d.data.dept.id===a.id&&(g=b)}),g>-1&&(f[g]=d.data.dept),d.data.roles&&d.data.dept.roles.length===d.data.roles.length&&(d.data.roles=d.data.dept.roles)}c.open(angular.extend({url:"js/tpl/user-info.html",width:500,depts:f,canGo:function(a){return d.mod||a.password===a.password2},ok:function(c){var d=c.roles.length>0?c.dept.roles:[];delete c.roles,angular.forEach(d,function(a,b){c["roles["+b+"].id"]=a.id}),c["dept.id"]=c.dept.id,delete c.dept,b.post("/user/saveUser.cmd",c,{success:function(){a.userGrid.refresh()}})}},d),a)}})},a.addUser=function(){a.openUserInfo({title:"新增用户"},a)},a.delUser=function(){var c=a.userGrid.selection.getSelectedRows(),d={userIds:[]};angular.forEach(c,function(a){d.userIds.push(a.id)}),b.post("/user/deleteUser.cmd",d,{success:function(){a.userGrid.refresh()}})},a.modUser=function(){var b=a.userGrid.selection.getSelectedRows()[0];a.openUserInfo({title:"修改用户",data:b,mod:!0},a)}}]),angular.module("xdApp",["xdApp.controllers","ngAnimate","ui.router","ngMaterial","ngAria","ui.grid","ui.grid.pagination","ui.grid.selection","ui.grid.autoResize","ui.grid.edit","multiselect-searchtree","ngPopover","ui.tree","lfNgMdFileInput"]).config(["$mdDateLocaleProvider",function(a){a.months=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],a.shortMonths=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],a.days=["周一","周二","周三","周四","周五","周六","周日"],a.shortDays=["一","二","三","四","五","六","日"],a.formatDate=function(a){return angular.isDate(a)?a.Format("yyyy-MM-dd"):a}}]).config(["$mdIconProvider","$mdThemingProvider",function(a,b){a.defaultIconSet("./img/svg/avatars.svg",128).icon("menu","./img/svg/menu.svg",24).icon("share","./img/svg/share.svg",24).icon("google_plus","./img/svg/google_plus.svg",24).icon("hangouts","./img/svg/hangouts.svg",24).icon("twitter","./img/svg/twitter.svg",24).icon("phone","./img/svg/phone.svg",24)}]).config(["$stateProvider","$urlRouterProvider","$logProvider",function(a,b){b.otherwise("/login"),a.state("user",{url:"/user",templateUrl:"user.html",controller:"UserCtrl"}).state("login",{url:"/login",templateUrl:"login.html",controller:"LoginCtrl"}).state("conf",{url:"/conf",templateUrl:"conf.html",controller:"ConfCtrl"}).state("product",{url:"/product",templateUrl:"product.html",controller:"ProductCtrl"}).state("product-item",{url:"/product-item",params:{product:null},templateUrl:"product-item.html",controller:"ProductItemCtrl"}).state("project",{url:"/project",templateUrl:"project.html",controller:"ProjectCtrl"}).state("project-item",{url:"/project-item",params:{project:null},templateUrl:"project-item.html",controller:"ProjectItemCtrl"}).state("budget",{url:"/budget",templateUrl:"budget.html",controller:"BudgetCtrl"}).state("budget-item",{url:"/budget-item",params:{budget:null},templateUrl:"budget-item.html",controller:"BudgetItemCtrl"}).state("progress",{url:"/progress",templateUrl:"progress.html",controller:"ProjectCtrl"}).state("progress-item",{url:"/progress-item",params:{project:null},templateUrl:"progress-item.html",controller:"ProgressItemCtrl"}).state("calculate",{url:"/calculate",templateUrl:"calculate.html",controller:"BudgetCtrl"}).state("calculate-item",{url:"/calculate-item",params:{budget:null},templateUrl:"calculate-item.html",controller:"CalculateItemCtrl"}).state("tax-calculate-item",{url:"/tax-calculate-item",params:{budgets:null},templateUrl:"tax-calculate-item.html",controller:"CalculateCtrl"}).state("supplier",{url:"/supplier",templateUrl:"supplier.html",controller:"SupplierCtrl"}).state("supplier-item",{url:"/supplier-item",params:{supplier:null},templateUrl:"supplier-item.html",controller:"SupplierItemCtrl"}).state("cost-tax",{url:"/cost-tax",params:{supplier:null},templateUrl:"cost-tax.html",controller:"CostTaxCtrl"}).state("purchase",{url:"/purchase",templateUrl:"purchase.html",controller:"ProjectCtrl"}).state("purchase-import",{url:"/purchase-import",params:{project:null},templateUrl:"purchase-import.html",controller:"PurchaseImportCtrl"}).state("engineering-purchase-item",{url:"/engineering-purchase-item",params:{project:null},templateUrl:"engineering-purchase-item.html",controller:"EngineeringPurchaseItemCtrl"}).state("receipt",{url:"/receipt",templateUrl:"receipt.html",controller:"ProjectCtrl"}).state("receipt-item",{url:"/receipt-item",params:{project:null},templateUrl:"receipt-item.html",controller:"ReceiptCtrl"}).state("receipt-progress-item",{url:"/receipt-progress-item",params:{project:null},templateUrl:"receipt-progress-item.html",controller:"ReceiptProgressItemCtrl"}).state("tax-manager",{url:"/tax-manager",params:{project:null},templateUrl:"tax-manager.html",controller:"ProjectCtrl"}).state("tax-analysis-in-count-item",{url:"/tax-analysis-in-count-item",params:{project:null},templateUrl:"tax-analysis-in-count-item.html",controller:"TaxAnalysisCtrl"}).state("tax-analysis-tax-item",{url:"/tax-analysis-tax-item",params:{project:null},templateUrl:"tax-analysis-tax-item.html",controller:"TaxAnalysisTaxCtrl"}).state("tax-man-manager",{url:"/tax-man-manager",templateUrl:"supplier.html",params:{man:!0},controller:"SupplierCtrl"})}]),services.config(["$httpProvider",function(a){a.defaults.transformRequest=function(a){var b=[];for(var c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")},a.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8",a.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded;charset=utf-8"}}]).config(["$locationProvider",function(a){}]),services.service("common",["$http","modal","$q","$timeout",function(a,b,c,d){this.async=function(a){var b=d(function(){a(),d.cancel(b)})},this.relativeUrl=function(a){return"../"+(0==a.indexOf("/")?a.substring(1):a)},this.loadAllPage2=function(a,b){var d=c.defer(),e=angular.extend({page:1,limit:999999},b);return this.post(a,e,function(a){d.resolve(a.data)}),d.promise},this.loadAllPage=function(a,b,c){return this.loadPage(a,angular.extend({page:1,limit:999999},c),b)},this.loadPage=function(a,b,c){return b=b||{},b&&(b.page=b.page||1,b.limit=b.limit||25),this.post(a,b,c)},this.post=function(c,d,e){d=d||{};for(var f in d)angular.isBlank(d[f])&&delete d[f];return a.post(this.relativeUrl(c),d).success(function(a){if(a&&a.errorMsg){if(e&&e.fail&&!e.fail(a))return;b.alert("操作失败，请重试或联系管理员。")}else angular.isFunction(e)?e(a):e&&e.success&&e.success(a)})},this.uploadFile=function(c,d,e){var f=new FormData;for(var g in d)angular.isBlank(d[g])||f.append(g,d[g]);b.wait(),a.post(this.relativeUrl(c),f,{transformRequest:angular.identity,headers:{"Content-Type":void 0}}).then(function(a){e&&e.success&&e.success(a),b.hide()},function(a){e&&e.fail&&e.fail(a),b.hide()})},this.createGridOption=function(a,b,c,d){return{paginationPageSizes:[25,50,75],paginationPageSize:25,useExternalPagination:!0,useExternalSorting:!0,columnDefs:a,configuration:d,refresh:function(a){a&&(this.paginationCurrentPage=1),c(this.paginationCurrentPage,this.paginationPageSize)},paginationTemplate:"js/tpl/pagination.html",onRegisterApi:function(a){this.selection||(this.selection=a.selection,a.pagination&&a.pagination.on.paginationChanged(b,c))}}}}]),angular.isFunction||(angular.isFunction=function(a){return a&&"[object Function]"==getClass.call(a)}),angular.isBlank||(angular.isBlank=function(a){return null===a||void 0===a||""===a||Array.isArray(a)&&0===a.length}),Date.prototype.Format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},Array.prototype.contains=function(a){var b=function(b){return angular.isFunction(a)?a(b):a===b},c=!1;return angular.forEach(this,function(a){b(a)&&(c=!0)}),c},Array.prototype.containsId=function(a){return this.contains(function(b){return b.id===a.id})},Array.prototype.each=function(a){angular.forEach(this,a)},Array.prototype.pushAll=function(a){var b=this;angular.forEach(a,function(a){b.push(a)})},angular.each||(angular.each=function(a,b){if(!angular.isBlank(a)&&b)for(var c,d=0;d<a.length;d++)if(c=b(a[d],d))return c}),services.service("configuration",["common",function(a){var b=this;this.parse=function(a){var c,d,e,f=a.data,g=b.configurations={};b.groups={};f.each(function(a){e=a.confName.indexOf("."),d=a.confName.substring(0,e),e=parseInt(a.confName.substring(e+1)),c=b.makeKey(a.groupNo,d),g[c]||(g[c]=[]),g[c][e]={index:e,value:a.confValue}})},a.loadPage("/conf/obtainConfigs.cmd",{page:1,limit:99999},{success:b.parse}),this.makeKey=function(a,b){return a+"-"+b},this.i18n=function(a,b,c){return this.configurations[this.makeKey(a,b)][c].value},this.group=function(a,b){var c=[];return angular.forEach(this.configurations[this.makeKey(a,b)],function(a){angular.isBlank(a)||c.push(angular.copy(a))}),c}}]),services.factory("supplierTypeName",["$http","$q",function(a,b){return{success:function(c){var d=this;if(d.data){var e=b.defer();e.promise.then(function(){c(d.data)}),e.resolve()}else a.get("../supplier/obtainSupplierTypeNames.cmd").success(function(a){var b=[];angular.forEach(a.data,function(a){b[a.degree]=b[a.degree]||[],b[a.degree].push(a)}),d.data=b,c(d.data)})}}}]),directives.directive("menuToggle",["$timeout",function(a){return{scope:{section:"="},templateUrl:"js/tpl/menu-toggle.tmpl.html",link:function(a,b){var c=b.parent().controller();a.isOpen=function(){return c.isOpen(a.section)},a.toggle=function(){c.toggleOpen(a.section)}}}}]).directive("menuLink",function(){return{scope:{section:"="},templateUrl:"js/tpl/menu-link.tmpl.html",link:function(a,b){var c=b.parent().controller();a.focusSection=function(){c.autoFocusContent=!0}}}}).filter("nospace",function(){return function(a){return a?a.replace(/ /g,""):""}}).filter("humanizeDoc",function(){return function(a){if(a)return"directive"===a.type?a.name.replace(/([A-Z])/g,function(a){return"-"+a.toLowerCase()}):a.label||a.name}}).filter("toFixed",function(){return function(a,b){return a.toFixed(b||2)}}).directive("xdDate",["$filter",function(a){return{restrict:"A",require:"ngModel",priority:1,link:function(b,c,d,e){e.$parsers.push(function(b){return a("date")(b,"yyyy-MM-dd")}),e.$formatters.push(function(a){return angular.isBlank(a)?"":new Date(a)})}}}]),services.factory("menu",["$state",function(a){var b,c=[];return b={sections:c,toggleSelectSection:function(a){b.openedSection=b.openedSection===a?null:a},isSectionSelected:function(a){return b.openedSection===a},parseMenu:function(a,b,c){var d={},e=c||"pages";return a.each(function(a){var b=a.id;d[b]?d[b]=angular.extend(d[b],a):(d[b]=angular.copy(a),d[b][e]=[],d[b].type="link"),a.routerId&&(d[b].state=a.routerId);var c=d[a.parentId];c||(c=d[a.parentId]={id:a.parentId},c[e]=[]),c[e].push(d[b]),c.type="toggle"}),b&&this.loadMenu(d[0][e]),d[0][e]},loadMenu:function(a){var b=this;b.sections=[],b.sections.push({name:"导航",state:"home",type:"heading"}),a.each(function(a){b.sections.push(a)})}}}]),services.service("modal",["$mdDialog",function(a){this.confirm=function(b,c){var d=a.confirm().title("提示信息").textContent(b).ok("继续").cancel("取消");a.show(d).then(function(){c&&c.postive&&c.postive()},function(){c&&c.negative&&c.negative()})},this.wait=function(){a.show({templateUrl:"js/tpl/wait.html",parent:angular.element(document.body)})},this.hide=function(){a.hide()},this.alert=function(b){a.show(a.alert().parent(angular.element(document.body)).clickOutsideToClose(!0).title("提示").textContent(b).ariaLabel("Alert Dialog Demo").ok("确定"))},this.open=function(b,c){a.show({controller:function(){this.data={},this.width=300,this.cancel=function(){a.cancel()},this.answer=function(){a.hide(this.data)};for(var d in b)this[d]=b[d];this.from=c},templateUrl:"js/tpl/dialog-common.html",parent:angular.element(document.body),targetEvent:b.ev,controllerAs:"modal",clickOutsideToClose:!1}).then(function(a){b.ok&&b.ok(a)},function(){b.cancel&&b.cancel()})}}]),services.service("module",["common","configuration",function(a,b){this.createUserGrid=function(b,c){return a.createGridOption([{name:"用户名",field:"name"},{name:"生日",field:"birthday"},{name:"性别",field:"sex",cellTemplate:"<div class=\"ui-grid-cell-contents\" >{{grid.getCellValue(row, col)===0?'女':'男'}}</div>"},{name:"入职时间",field:"entryTime"},{name:"手机号码",field:"mobile"},{name:"固定电话",field:"phone"},{name:"身份证号",field:"idCard"},{name:"邮箱",field:"mail"},{name:"部门",field:"dept.name"}],b,c)},this.createDeptGrid=function(b,c){return a.createGridOption([{name:"部门名",field:"name"},{name:"角色",field:"roleNames"}],b,c)},this.createRoleGrid=function(b,c){return a.createGridOption([{name:"角色名",field:"name"}],b,c)},this.createConfGrid=function(b,c){return a.createGridOption([{name:"组编号",field:"groupNo"},{name:"配置名",field:"confName"},{name:"配置值",field:"confValue"},{name:"描述",field:"confDesc"}],b,c)},this.createProductGrid=function(b,c,d){return a.createGridOption([{name:"商品编号",field:"code",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.showDetail(row)"><a href="javascript:void(0)">{{grid.getCellValue(row, col)}}</a></div>'},{name:"商品名称",field:"name"},{name:"规格型号",field:"model"},{name:"商品性质",field:"nature",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(1,"nature",row.entity.nature)}}</div>'},{name:"所属类型",field:"genre",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(1,"genre",row.entity.genre)}}</div>'},{name:"单位",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(1,"weightUnit",row.entity.weightUnit) + "/" + grid.options.configuration.i18n(1,"countUnit",row.entity.countUnit) + "/" + grid.options.configuration.i18n(1,"bulkUnit",row.entity.bulkUnit)}}</div>'},{name:"包装规格",field:"packageType"},{name:"税率",field:"rate"},{name:"状态",field:"status",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.status === 0 ? "待审核": "己审核"}}</div>'}],b,c,d)},this.createProductImportGrid=function(b,c){return a.createGridOption([{name:"导入",field:"operator"},{name:"状态",field:"status",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.status === 0 ? "待审核": "己审核"}}</div>'},{name:"导入时间",field:"createTime"}],b,c)},this.getProductTypes=function(a){return a=a||{},a.natures=b.group(1,"nature"),a.genres=b.group(1,"genre"),a.countUnits=b.group(1,"countUnit"),a.weightUnits=b.group(1,"weightUnit"),a.bulkUnits=b.group(1,"bulkUnit"),a},this.createProjectGrid=function(b,c,d){return a.createGridOption([{name:"项目名称",field:"name",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.showDetail(row)"><a href="javascript:void(0)">{{grid.getCellValue(row, col)}}</a></div>'},{name:"发包方",field:"employer"},{name:"项目承接方式",field:"projectMode",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.projectMode === 0 ? "总包": "分包"}}</div>'},{name:"项目类型",field:"projectType",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(2,"projectType",row.entity.projectType)}}</div>'},{name:"项目经理",field:"manager"},{name:"施工合同号",field:"contractNumber"},{name:"施工合同签署日期",field:"contractSignDate"},{name:"合同金额",field:"totalCount"}],b,c,d)},this.getProjectTypes=function(a){return a=a||{},a.projectTypes=b.group(2,"projectType"),a.rates=b.group(2,"rate"),a},this.getSupplierTypes=function(a){return a=a||{},a.identities=b.group(3,"identity"),a.countUnits=b.group(1,"countUnit"),a},this.createBudgetGrid=function(b,c,d){return a.createGridOption([{name:"工程名",field:"importName",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.showDetail(row)"><a href="javascript:void(0)">{{grid.getCellValue(row, col)}}</a></div>'},{name:"所属项目",field:"project.name"},{name:"导入者",field:"importUser"},{name:"导入时间",field:"importDate"}],b,c,d)},this.createPurchaseImportGrid=function(b,c,d){return a.createGridOption([{name:"项目名称",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.appScope.project.name}}</div>'},{name:"所属年月",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.appScope.onlyYearAndMonth(row.entity.belong)}}</div>'},{name:"导入者",field:"operator"},{name:"导入时间",field:"createTime"}],b,c,d)},this.createPurchaseGrid=function(b,c,d){return a.createGridOption([{name:"所属年月",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.appScope.onlyYearAndMonth(row.entity.belong)}}</div>'},{name:"供应商名称",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.company || row.entity.supplier.name}}</div>'},{name:"商品服务名",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.productName || row.entity.name}}</div>'},{name:"商品规格型号",field:"productModel"},{name:"计量单位",cellTemplate:'<div class="ui-grid-cell-contents" >{{grid.options.configuration.i18n(1,"countUnit",row.entity.productUnit)}}</div>'},{name:"入库数量",field:"productCount"},{name:"不含税单价",field:"price"},{name:"不含税金额",field:"unTaxCount"},{name:"税率",field:"rate"},{name:"税额",field:"rateCount"},{name:"价税合计金额",field:"total"}],b,c,d)},this.createEngineeringPurchaseGrid=function(b,c,d){return a.createGridOption([{name:"采购时间",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.appScope.onlyYearAndMonth(row.entity.belong)}}</div>'},{name:"部门",field:"dept.name"},{name:"项目名称",field:"project.name"},{name:"供应商",field:"supplier.name"},{name:"货物或应税劳务、服务名称",field:"name"},{name:"规格型号",field:"productModel"},{name:"不含税单价",field:"price"},{name:"数量",field:"productCount"},{name:"不含税金额",field:"unTaxCount"},{name:"税率",field:"rate"},{name:"税额",field:"rateCount"},{name:"价税合计金额",field:"total"}],b,c,d)},this.createConstructionItemGrid=function(b,c,d){return a.createGridOption([{name:"所属月份",field:"belong"},{name:"上期累加",field:"lastAllCount"},{name:"本月完工",field:"finished"},{name:"施工面积",field:"area"},{name:"进度累计",field:"allProgress",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.lastAllCount + row.entity.finished}}</div>'}],b,c,d)},this.createSupplierGrid=function(b,c,d){return a.createGridOption([{name:"供应商名称",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.showDetail(row.entity, false)"><a href="javascript:">{{row.entity.name}}</a></div>',width:"19%"},{name:"供应商税号",field:"licenseCode",width:"19%"},{name:"供应商纳税人身份类别",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.options.configuration.i18n(3,"identity",row.entity.identityType)}}</div>',width:"19%"},{name:"资质是否上传",width:"40%",cellTemplate:['<input type="checkbox" ng-checked="row.entity.licenseImg">营业执照</input>','<input type="checkbox" ng-checked="row.entity.registryImg">税务登记证</input>','<input type="checkbox" ng-checked="row.entity.organizationImg">组织机构代码证</input>','<input type="checkbox" ng-checked="row.entity.openAccountImg">开户许可证</input>'].join("")}],b,c,d)},this.createSupplierGrid2=function(b,c,d){return a.createGridOption([{name:"供应商名称",cellTemplate:'<div class="ui-grid-cell-contents" ng-click="grid.appScope.showDetail(row.entity, false)"><a href="javascript:">{{row.entity.name}}</a></div>',width:"19%"},{name:"供应商税号",field:"licenseCode",width:"19%"},{name:"供应商纳税人身份类别",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.options.configuration.i18n(3,"identity",row.entity.identityType)}}</div>',width:"19%"},{name:"纳税人身份复核",width:"40%",cellTemplate:'<div class="ui-grid-cell-contents"><a href="http://www.yibannashuiren.com/">http://www.yibannashuiren.com</a></div>'}],b,c,d)},this.createContractGrid=function(b,c,d){return a.createGridOption([{name:"所属月份",field:"belong"},{name:"合同金额",field:"project.totalCount"},{name:"上期完成合同金额",field:"lastAllCount"},{name:"已完成合同金额",field:"finished"},{name:"剩余合同金额",cellTemplate:'<div class="ui-grid-cell-contents" >{{row.entity.project.totalCount - row.entity.lastAllCount - row.entity.finished}}</div>'},{name:"合同完成率（%）",field:"progressRate",cellTemplate:'<div class="ui-grid-cell-contents" >{{(row.entity.lastAllCount + row.entity.finished) * 100 / row.entity.project.totalCount}}</div>'}],b,c,d)},this.createReceiptGrid=function(b,c,d){return a.createGridOption([{name:"所属月份",cellTemplate:'<div class="ui-grid-cell-contents">{{grid.appScope.onlyYearAndMonth(row.entity.belong)}}</div>'},{name:"项目名称",field:"project.name"},{name:"至上期收款累计",field:"allByLastMonth",cellFilter:"toFixed"},{name:"本月回款额",field:"count",cellFilter:"toFixed"},{name:"累计收款（含跨年）",field:"allByNow",cellFilter:"toFixed"},{name:"完成进度回款率（%）",field:"percent"}],b,c,d)}}]),services.service("util",["common",function(a){this.taxCount=function(a){return null!==a.taxRatio?a.total*a.taxRatio/(a.taxRatio+1):0},this.rate=function(a){var b=[];return a.replace(/(\d+)%/g,function(a,c){b.push(parseInt(c))}),b},this.downloadFile=function(a,b){a+="?",angular.forEach(b,function(b,c){a+=c+"="+b+"&"}),window.open(a,"_self")}}]),directives.directive("xdGrid",["$timeout",function(a){return{scope:{grid:"="},templateUrl:"js/tpl/xd-grid-tmpl.html",link:function(a,b,c){b.parent().controller()},compile:function(a,b){}}}]);